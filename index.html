<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0b0f1a" />
  <title>ì»¤íŠ¼ì½œ (CurtainCall) - í‹°ì¼“íŒ… ì—°ìŠµ</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#7c3aed;
      --btn:#111827;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      background:var(--bg);
      color:#111827;
      overscroll-behavior:none;
      -webkit-tap-highlight-color: transparent;
    }

    .frame{
      width:100%;
      max-width:430px;
      height:100dvh;
      margin:0 auto;
      background:#f3f4f6;
      position:relative;
      overflow:hidden;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
    }

    .topbar{
      height:56px;
      padding:0 14px;
      display:flex;
      align-items:center;
      gap:10px;
      background:rgba(0,0,0,.55);
      color:#fff;
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
    }
    .iconbtn{
      width:36px;height:36px;border-radius:999px;
      display:grid;place-items:center;
      border:0;background:rgba(255,255,255,.12);
      color:#fff;font-size:18px;
      cursor:pointer;
    }
    .title{
      flex:1;
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .content{
      height: calc(100dvh - 56px);
      overflow:auto;
      padding-bottom: 88px;
      background:#fff;
    }

    .counters{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 16px;
      background:#fff;
      border-bottom:1px solid var(--line);
      font-size:13px;
      color:#111827;
      position:sticky;
      top:0;
      z-index:5;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:7px 10px;
      border-radius:999px;
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      font-weight:900;
    }
    .chip b{font-variant-numeric: tabular-nums;}
    .spacer{flex:1}
    .mini{
      font-size:12px; color:var(--muted);
      font-weight:800;
    }

    /* í•˜ë‹¨ ê³ ì • ë²„íŠ¼ */
    .bottom{
      position:absolute;
      left:0; right:0; bottom:0;
      padding:12px 16px 18px;
      background: linear-gradient(to top, rgba(255,255,255,1), rgba(255,255,255,.86));
      border-top:1px solid var(--line);
      z-index:20;
    }
    .primaryBtn{
      width:100%;
      height:56px;
      border-radius:14px;
      border:0;
      background: #9ca3af;
      color:#fff;
      font-size:18px;
      font-weight:1000;
      letter-spacing:-.2px;
    }
    .primaryBtn.ready{ background: var(--btn); cursor:pointer; }

    /* âœ… ê´‘ê³  ì»¨í…Œì´ë„ˆ (ì˜ˆë§¤ ì‹œì‘ ì „ íŒì—… ì˜ì—­) */
    .adSlot{
      margin: 12px 16px 0;
      border: 1px dashed #c7cbd1;
      background: #f8fafc;
      border-radius: 14px;
      padding: 12px;
      color: #64748b;
      font-weight: 900;
      font-size: 13px;
      line-height: 1.4;
    }
    .adSlot small{display:block; font-weight:800; color:#94a3b8; margin-top:6px;}
    .adSlot.hidden{ display:none; }

    /* âœ… ì„±ê³µ í›„ ë°°ë„ˆ ê´‘ê³  ìŠ¬ë¡¯ */
    .adBanner{
      border: 1px dashed #c7cbd1;
      background: #f8fafc;
      border-radius: 12px;
      padding: 10px 12px;
      color:#64748b;
      font-weight: 900;
      font-size: 12px;
      line-height: 1.35;
    }
    .adBanner small{display:block; font-weight:800; color:#94a3b8; margin-top:4px;}

    /* ëª¨ë‹¬ */
    .overlay{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .overlay.show{display:flex;}
    .modal{
      width:100%;
      max-width: 380px;
      background:#fff;
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.18);
    }
    .modalHeader{
      padding:16px 16px 10px;
      font-weight:1000;
      font-size:18px;
      border-bottom:1px solid var(--line);
    }
    .modalBody{padding:14px 16px; color:#111827; white-space:pre-line;}
    .modalActions{
      padding:14px 16px 16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      flex:1;
      min-width:110px;
      height:46px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#f9fafb;
      font-weight:1000;
      cursor:pointer;
    }
    .btn.primary{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }

    /* í™”ë©´ ì „í™˜ */
    .screen{display:none;}
    .screen.show{display:block;}

    /* ê·¹ì¥ ì„ íƒ */
    .pad{padding:16px}
    .h2{
      font-weight:1000;
      font-size:22px;
      margin:6px 0 12px;
      letter-spacing:-.3px;
    }
    .sub{color:var(--muted); font-weight:900; font-size:13px; margin-bottom:14px;}
    .theaterList{display:grid; gap:14px;}
    .theaterCard{
      border:2px solid #e5e7eb;
      border-radius:16px;
      overflow:hidden;
      background:#fff;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      cursor:pointer;
      position:relative;
    }
    .theaterCard.sel{border-color: var(--accent); box-shadow: 0 12px 36px rgba(124,58,237,.18);}
    .theaterCard img{width:100%; display:block; object-fit:cover;}
    .theaterTag{
      position:absolute; left:12px; top:12px;
      background:rgba(17,24,39,.8);
      color:#fff;
      padding:7px 10px;
      border-radius:999px;
      font-weight:1000;
      font-size:13px;
      backdrop-filter: blur(6px);
    }

    /* ì˜ˆë§¤ ìƒì„¸ */
    .hero{height:210px;background:#111827;position:relative;overflow:hidden;}
    .hero img{width:100%;height:100%;object-fit:cover;display:block;}
    .hero .dim{position:absolute; inset:0; background: radial-gradient(ellipse at center, rgba(0,0,0,.15), rgba(0,0,0,.55)); pointer-events:none;}
    .section{padding:14px 16px;border-bottom:1px solid var(--line);}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background:#eef2ff;color:#4f46e5;
      font-weight:1000;font-size:12px;margin-bottom:10px;
    }
    .h1{font-size:28px;line-height:1.18;font-weight:1000;letter-spacing:-.4px;margin:0 0 8px 0;word-break:keep-all;}
    .meta{display:grid;gap:10px;color:#111827;}
    .row{display:flex;gap:12px;align-items:flex-start;}
    .label{width:42px;color:var(--muted);font-weight:900;}
    .value{flex:1}
    .muted{color:var(--muted)}

    /* ëŒ€ê¸° */
    .waitCard{margin:14px 16px;border-radius:18px;border:1px solid var(--line);overflow:hidden;background:#fff;}
    .waitTop{padding:18px 16px 12px;border-bottom:1px solid var(--line);}
    .waitTop .msg1{font-weight:1000;font-size:18px;}
    .waitTop .msg2{font-weight:1000;font-size:18px;color:var(--danger);}
    .waitMid{padding:18px 16px 16px;text-align:center;}
    .waitNumLabel{font-weight:900;color:var(--muted);margin-bottom:6px;}
    .waitNum{font-weight:1000;font-size:74px;line-height:1;font-variant-numeric: tabular-nums;}
    .bar{height:18px;background:#fee2e2;border-radius:999px;overflow:hidden;margin:16px 0 10px;border:1px solid #fecaca;}
    .bar > div{height:100%;width:0%;background:#ef4444;border-radius:999px;transition: width .2s linear;}
    .waitBottom{padding:10px 16px 18px;color:var(--muted);font-size:13px;line-height:1.5;border-top:1px solid var(--line);background:#fafafa;}
    .waitStats{display:flex;justify-content:space-between;margin-top:10px;color:#111827;font-weight:1000;}
    .waitStats span{color:var(--muted);font-weight:900;margin-right:8px;}

    /* ë‹¬ë ¥ */
    .calWrap{padding:14px 16px 8px;}
    .calTitle{font-weight:1000;font-size:28px;text-align:center;margin:10px 0 12px;font-variant-numeric: tabular-nums;letter-spacing:-.4px;}
    .dow{display:grid;grid-template-columns: repeat(7, 1fr);gap:6px;padding:0 4px 10px;color:var(--muted);font-weight:1000;text-align:center;}
    .grid{display:grid;grid-template-columns: repeat(7, 1fr);gap:8px;padding:0 4px 10px;}
    .day{height:44px;border-radius:999px;display:grid;place-items:center;font-weight:1000;color:#111827;background:#f3f4f6;border:1px solid #e5e7eb;user-select:none; cursor:pointer;}
    .day.off{opacity:.35; cursor:default;}
    .day.sel{background: var(--accent);color:#fff;border-color: var(--accent);transform: scale(1.02);}

    /* ìº¡ì°¨ */
    .capWrap{padding:14px 16px}
    .capCard{border:1px solid var(--line);border-radius:18px;padding:16px;background:#fff;}
    .capTitle{font-weight:1000;font-size:18px;margin-bottom:10px;}
    .capImg{
      height:64px;border-radius:14px;border:1px dashed #c7cbd1;
      background: linear-gradient(135deg, #f8fafc, #eef2ff);
      display:flex;align-items:center;justify-content:center;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-weight:1000;letter-spacing:6px;font-size:26px;position:relative;overflow:hidden;user-select:none;
    }
    .capImg::before{
      content:"";position:absolute; inset:-40px;
      background:
        repeating-linear-gradient(20deg, rgba(0,0,0,.06) 0 2px, transparent 2px 10px),
        repeating-linear-gradient(-12deg, rgba(124,58,237,.09) 0 2px, transparent 2px 12px);
      transform: rotate(-4deg);opacity:.8;
    }
    .capImg span{position:relative; z-index:1; text-shadow: 0 2px 0 rgba(0,0,0,.06);}
    .capRow{display:flex;gap:10px;margin-top:12px;}
    .capRow input{
      flex:1;height:46px;border-radius:12px;border:1px solid var(--line);
      padding:0 12px;font-size:16px;font-weight:1000;outline:none;
    }
    .capRow input:focus{border-color:#c4b5fd; box-shadow:0 0 0 4px rgba(124,58,237,.12)}
    .capRow button{
      width:90px;height:46px;border-radius:12px;border:0;background:#111827;color:#fff;
      font-weight:1000;font-size:15px;cursor:pointer;
    }
    .capHint{margin-top:10px;color:var(--muted);font-weight:900;font-size:13px;}
    .shake{animation: shake .18s linear 0s 3;}
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      50%{transform:translateX(6px)}
      75%{transform:translateX(-4px)}
      100%{transform:translateX(0)}
    }

    /* ì¢Œì„(í¬ë„ì•Œ) */
    .seatWrap{padding:14px 16px 18px}
    .seatTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }
    .seatTop .stTitle{font-weight:1000;font-size:18px;}
    .seatTop .stSub{color:var(--muted);font-weight:900;font-size:13px;margin-top:4px;}

    .seatTopActions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .seatTopActions .miniBtn{
      height:34px;
      padding:0 12px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#111827;
      color:#fff;
      font-weight:1000;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
    }
    .seatTopActions .miniBtn.secondary{
      background:#fff;
      color:#111827;
    }

    /* ğŸ”’ ì ê¹€ ìƒíƒœ ë²„íŠ¼ ëŠë‚Œ */
    .miniBtn.locked{
      background:#111827;
      position:relative;
      opacity:.92;
    }
    .miniBtn.locked::after{
      content:"ğŸ”’";
      margin-left:6px;
    }

    .seatCard{border:1px solid var(--line);border-radius:18px;overflow:hidden;background:#fff;}
    .seatHeader{padding:12px 14px;border-bottom:1px solid var(--line);background:#fafafa;font-weight:1000;}
    .seatStage{padding:14px;background:#fff;}

    .seatBoard{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius:14px;
      border:2px solid #111827;
      background:#f8fafc;
      position:relative;
      overflow:hidden;
      touch-action:none;
    }

    /* ì¤Œ/ë“œë˜ê·¸ìš© ë·°í¬íŠ¸ */
    .seatViewport{
      position:absolute;
      inset:0;
      transform-origin: 0 0;
      will-change: transform;
    }

    /* ì¢Œì„ ë°°ì¹˜ë„ ì´ë¯¸ì§€ */
    #seatMapImg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:contain;
      pointer-events:none;
      user-select:none;
      -webkit-user-drag:none;
    }

    /* ì¢Œì„ ì (í¬ë„ì•Œ) */
    .seatDot{
      position:absolute;
      width: var(--dotSize, 10px);
      height: var(--dotSize, 10px);
      border-radius:999px;
      transform: translate(-50%, -50%);
      border: 2px solid rgba(17,24,39,.55);
      background: rgba(255,255,255,.55);
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
      cursor:pointer;
    }
    .seatDot.playable{
      border-color:#6d28d9;
      background:#7c3aed;
      box-shadow: 0 6px 18px rgba(124,58,237,.25);
    }
    .seatDot.off{
      opacity:.18;
      background:#e5e7eb;
      border-color:#e5e7eb;
      box-shadow:none;
      cursor:not-allowed;
    }
    .seatDot.edit{ cursor:crosshair; }

    /* ìŠ¤ëƒ… ê°€ì´ë“œ */
    .snapGuide{
      position:absolute;
      width:10px;height:10px;
      border-radius:999px;
      transform: translate(-50%, -50%);
      border:2px dashed rgba(124,58,237,.55);
      background: rgba(124,58,237,.06);
      pointer-events:none;
    }

    .seatFooter{
      padding:12px 14px;border-top:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center;gap:10px;background:#fafafa;font-weight:1000;
    }
    .seatFooter .left{color:var(--muted);font-weight:1000;}
    .seatFooter .right{font-variant-numeric:tabular-nums;}

    /* âœ… ë‚œì´ë„ ì„ íƒ UI */
    .diffRow{
      display:flex;
      gap:10px;
      margin:10px 0 10px;
    }
    .diffBtn{
      flex:1;
      height:44px;
      border-radius:12px;
      border:2px solid #e5e7eb;
      background:#f9fafb;
      font-weight:1000;
      cursor:pointer;
    }
    .diffBtn.sel{
      border-color: var(--accent);
      background: rgba(124,58,237,.10);
    }
    .diffHint{
      color: var(--muted);
      font-weight:900;
      font-size:12px;
      line-height:1.4;
      margin-bottom: 2px;
    }

    /* âœ… í¬ë„ì•Œ/ì¢Œì„ ì¤Œ UI (ê²Œì„/í¸ì§‘ ëª¨ë‘ ì‚¬ìš©) */
    .zoomUI{
      position: fixed;
      right: 14px;
      bottom: 16px;
      display:flex;
      gap:8px;
      align-items:center;
      background: rgba(0,0,0,.55);
      padding: 10px 12px;
      border-radius: 14px;
      z-index: 9999;
      backdrop-filter: blur(10px);
    }
    .zoomUI button{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 0;
      background: rgba(255,255,255,.18);
      color:#fff;
      font-weight:1000;
      font-size:16px;
      cursor:pointer;
    }
    .zoomUI span{
      color:#fff;
      font-weight:1000;
      min-width: 62px;
      text-align:center;
      font-variant-numeric: tabular-nums;
      font-size: 12px;
    }
    .zoomUI.hidden{ display:none; }

    /* âœ… ì¢Œì„ ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°ìš© í…ìŠ¤íŠ¸ ì˜ì—­ */
    .transferArea{
      width:100%;
      min-height: 180px;
      border-radius: 12px;
      border:1px solid #e5e7eb;
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 900;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      line-height: 1.35;
      outline:none;
      resize: vertical;
    }
    .transferArea:focus{
      border-color:#c4b5fd;
      box-shadow:0 0 0 4px rgba(124,58,237,.12);
    }
    .transferArea.hidden{ display:none; }
  </style>
</head>

<body>
  <div class="frame" id="frame">
    <div class="topbar">
      <button class="iconbtn" id="navBack" aria-label="ì´ì „">â†</button>
      <div class="title" id="topTitle">ì»¤íŠ¼ì½œ (CurtainCall)</div>
      <button class="iconbtn" id="noop" aria-label="ë¹ˆë²„íŠ¼" style="opacity:.0; pointer-events:none;">â‹®</button>
    </div>

    <div class="content" id="content">
      <div class="counters">
        <span class="chip">ëˆ„ì  ì‹œì‘ <b id="uStarts">0</b></span>
        <span class="spacer"></span>
        <span class="mini" id="phaseText">-</span>
      </div>

      <!-- í™”ë©´ 0: ê·¹ì¥ ì„ íƒ -->
      <div class="screen show" id="scrTheater">
        <div class="pad">
          <div class="h2">ê·¹ì¥ì„ ì„ íƒí•˜ì„¸ìš”</div>
          <div class="sub">ê·¹ì¥ ì„ íƒ í›„ í•˜ë‹¨ â€œì‹œì‘í•˜ê¸°â€ë¥¼ ëˆŒëŸ¬ ì˜ˆë§¤ í˜ì´ì§€ë¡œ ì´ë™í•˜ì„¸ìš”.</div>

          <div class="theaterList">
            <div class="theaterCard" data-theater="big">
              <span class="theaterTag">ëŒ€ê·¹ì¥</span>
              <img src="theater_big.png" alt="ëŒ€ê·¹ì¥" />
            </div>

            <div class="theaterCard" data-theater="mid">
              <span class="theaterTag">ì¤‘ê·¹ì¥</span>
              <img src="theater_mid.png" alt="ì¤‘ê·¹ì¥" />
            </div>

            <div class="theaterCard" data-theater="small">
              <span class="theaterTag">ì†Œê·¹ì¥</span>
              <img src="theater_small.png" alt="ì†Œê·¹ì¥" />
            </div>
          </div>

          <div class="muted" style="margin-top:14px; font-weight:900; font-size:12px;"></div>
        </div>
      </div>

      <!-- í™”ë©´ 1: ì˜ˆë§¤ ìƒì„¸ -->
      <div class="screen" id="scrDetail">
        <div class="hero">
          <img src="poster.png" alt="í¬ìŠ¤í„°" />
          <div class="dim"></div>
        </div>

        <div class="section">
          <div class="badge" id="detailBadge">ë®¤ì§€ì»¬ Â· ê°€ìƒ</div>
          <h1 class="h1" id="detailTitle">CurtainCall Musical</h1>

          <div class="meta">
            <div class="row"><div class="label">ì¢…ë¥˜</div><div class="value">ë®¤ì§€ì»¬ Â· ë§Œ 8ì„¸ ì´ìƒ ê´€ëŒê°€</div></div>
            <div class="row"><div class="label">ì¥ì†Œ</div><div class="value" id="detailPlace">-</div></div>
            <div class="row"><div class="label">ê¸°ê°„</div><div class="value">2026.03.01 ~ 2026.03.31</div></div>
          </div>
        </div>

        <div class="section muted" style="font-weight:900;"></div>

        <!-- âœ… "ì‹œì‘í•˜ê¸° ëˆ„ë¥´ê¸° ì „" íŒì—… ê´‘ê³  ìë¦¬ -->
        <div class="adSlot" id="adPreStart">
          ğŸ“Œ (ê´‘ê³  ìë¦¬) ì‹œì‘ ì „ íŒì—…/ì „ë©´ ê´‘ê³  ì»¨í…Œì´ë„ˆ<br/>
          <small>ì—¬ê¸°ì— AdSense/Adfit ì½”ë“œ(ë˜ëŠ” ì»¤ìŠ¤í…€ íŒì—…)ë¥¼ ë„£ìœ¼ë©´ ë¨. ì‹œë®¬ ì‹œì‘ í›„ì—ëŠ” ìë™ ìˆ¨ê¹€.</small>
        </div>
      </div>

      <!-- í™”ë©´ 2: ëŒ€ê¸°ìˆœì„œ -->
      <div class="screen" id="scrWait">
        <div class="waitCard">
          <div class="waitTop">
            <div class="msg1">ê³§ ê³ ê°ë‹˜ì˜ ìˆœì„œê°€ ë‹¤ê°€ì˜µë‹ˆë‹¤.</div>
            <div class="msg2">ì˜ˆë§¤ë¥¼ ì¤€ë¹„í•´ì£¼ì„¸ìš”.</div>
          </div>
          <div class="waitMid">
            <div class="waitNumLabel">ë‚˜ì˜ ëŒ€ê¸°ìˆœì„œ</div>
            <div class="waitNum" id="waitNum">----</div>
            <div class="bar"><div id="waitBar"></div></div>
          </div>
          <div class="waitBottom">
            â€¢ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì‹œë©´, ì˜ˆë§¤ í˜ì´ì§€ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.<br/>
            â€¢ ìƒˆë¡œê³ ì¹¨/ì¬ì ‘ì† ì‹œ ëŒ€ê¸°ìˆœì„œê°€ ì´ˆê¸°í™”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            <div class="waitStats">
              <div><span>í˜„ì¬ ëŒ€ê¸°ì¸ì›</span><b id="waitPeople">-</b></div>
              <div><span>ë‚´ ìˆœì„œ</span><b id="waitSmall">-</b></div>
            </div>
          </div>
        </div>
      </div>

      <!-- í™”ë©´ 3: ë‹¬ë ¥ -->
      <div class="screen" id="scrCal">
        <div class="calWrap">
          <div class="calTitle" id="calYM">2026.03</div>
          <div class="dow">
            <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
          </div>
          <div class="grid" id="calGrid"></div>
          <div class="muted" style="padding:8px 4px 18px;font-weight:900;">
            ë‚ ì§œë¥¼ ëˆ„ë¥´ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.
          </div>
        </div>
      </div>

      <!-- í™”ë©´ 4: ë³´ì•ˆë¬¸ì -->
      <div class="screen" id="scrCaptcha">
        <div class="capWrap">
          <div class="capCard" id="capCard">
            <div class="capTitle">ë³´ì•ˆë¬¸ì ì…ë ¥</div>
            <div class="capImg"><span id="capText">-----</span></div>
            <div class="capRow">
              <input id="capInput" autocomplete="off" autocapitalize="characters" spellcheck="false" placeholder="ë³´ì•ˆë¬¸ì ì…ë ¥" />
              <button id="capOk">í™•ì¸</button>
            </div>
            <div class="capHint" id="capHint">ì´ë¯¸ì§€ì— ë³´ì´ëŠ” ë¬¸ìë¥¼ ê·¸ëŒ€ë¡œ ì…ë ¥í•˜ê³  í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
          </div>
        </div>
      </div>

      <!-- í™”ë©´ 5: í¬ë„ì•Œ(ì¢Œì„) -->
      <div class="screen" id="scrSeats">
        <div class="seatWrap">
          <div class="seatTop">
            <div>
              <div class="stTitle" id="seatTitle">ìë¦¬ ì¡ê¸°</div>
              <div class="stSub" id="seatSub">ë‚¨ì€ ìë¦¬ë¥¼ í´ë¦­í•˜ë©´ ì„±ê³µ!</div>
            </div>

            <div class="seatTopActions">
              <button class="miniBtn locked" id="editSeatsBtn" type="button">ì¢Œì„ì„¤ì •</button>
              <button class="miniBtn secondary" id="exportSeatsBtn" type="button" style="display:none;">ë‚´ë³´ë‚´ê¸°</button>
              <button class="miniBtn secondary" id="importSeatsBtn" type="button" style="display:none;">ê°€ì ¸ì˜¤ê¸°</button>

              <button class="miniBtn secondary" id="saveSeatsBtn" type="button" style="display:none;">ì €ì¥</button>
              <button class="miniBtn secondary" id="resetSeatsBtn" type="button" style="display:none;">ì´ˆê¸°í™”</button>
              <button class="miniBtn secondary" id="snapBuildBtn" type="button" style="display:none;">ìŠ¤ëƒ… ê°€ì´ë“œ ìƒì„±</button>
              <button class="miniBtn secondary" id="zoomResetBtn" type="button" style="display:none;">ì¤Œ ë¦¬ì…‹</button>
            </div>
          </div>

          <div class="seatCard">
            <div class="seatHeader" id="seatHeaderText"></div>
            <div class="seatStage">
              <div class="seatBoard" id="seatBoard" aria-label="ì¢Œì„ ë³´ë“œ">
                <div class="seatViewport" id="seatViewport">
                  <img id="seatMapImg" alt="ì¢Œì„ ë°°ì¹˜ë„" />
                </div>
              </div>
            </div>
            <div class="seatFooter">
              <div class="left">ë‚¨ì€ í¬ë„ì•Œ</div>
              <div class="right" id="remainCount">-</div>
            </div>
          </div>

          <div class="muted" style="margin-top:12px; font-weight:900; font-size:12px; line-height:1.5;"></div>
        </div>
      </div>
    </div>

    <!-- í•˜ë‹¨ ë²„íŠ¼ -->
    <div class="bottom" id="bottomBar">
      <button class="primaryBtn" id="mainBtn" disabled>ì‹œì‘í•˜ê¸°</button>
    </div>

    <!-- ì˜ˆë§¤ ì‹œì‘ ëª¨ë‹¬ -->
    <div class="overlay" id="startOverlay">
      <div class="modal">
        <div class="modalHeader">ì—°ìŠµ ì‹œì‘</div>

        <div class="modalBody">
          'ì‹œì‘í•˜ê¸°'ë¥¼ ëˆ„ë¥´ë©´ 10ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´ í›„ 'ì˜ˆë§¤í•˜ê¸°' ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
        </div>

        <div class="modalBody" style="padding-top:0;">
          <div style="font-weight:1000; margin:6px 0 10px;">ë‚œì´ë„ ì„ íƒ</div>

          <div class="diffRow" role="radiogroup" aria-label="ë‚œì´ë„ ì„ íƒ">
            <button class="diffBtn" data-diff="high" type="button">ìƒ</button>
            <button class="diffBtn" data-diff="mid"  type="button">ì¤‘</button>
            <button class="diffBtn" data-diff="low"  type="button">í•˜</button>
          </div>

          <div class="diffHint" id="diffHint">-</div>
        </div>

        <div class="modalActions">
          <button class="btn" id="startCancel">ë‹«ê¸°</button>
          <button class="btn primary" id="startGo">ì‹œì‘í•˜ê¸°</button>
        </div>
      </div>
    </div>

    <!-- ë©”ì‹œì§€ ëª¨ë‹¬ -->
    <div class="overlay" id="msgOverlay">
      <div class="modal">
        <div class="modalHeader" id="msgTitle">ì•ˆë‚´</div>

        <div class="modalBody" id="msgBody">-</div>

        <div class="modalBody" id="transferBox" style="display:none; padding-top:0;">
          <textarea id="transferArea" class="transferArea" spellcheck="false" placeholder="ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸° / ì—¬ê¸°ì„œ ë³µì‚¬í•˜ê¸°"></textarea>
          <div class="muted" style="margin-top:8px; font-weight:900; font-size:12px; line-height:1.4;">
            â€¢ ë‚´ë³´ë‚´ê¸°: ì´ ì¹¸ì˜ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ì„œ ì €ì¥í•´ë‘¬<br/>
            â€¢ ê°€ì ¸ì˜¤ê¸°: ì €ì¥í•´ë‘” JSONì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê³  â€˜ê°€ì ¸ì˜¤ê¸° ì ìš©â€™ ëˆ„ë¥´ë©´ ë
          </div>
        </div>

        <div class="modalBody" id="successAds" style="display:none; padding-top:0;">
          <div class="adBanner" id="adBannerTop">
            (ê´‘ê³  ìë¦¬) ì„±ê³µ í›„ ìƒë‹¨ ë°°ë„ˆ
            <small>ì—¬ê¸°ì— ë°°ë„ˆ ê´‘ê³  ì½”ë“œ ë¶™ì´ë©´ ë¨</small>
          </div>
          <div style="height:10px"></div>
          <div class="adBanner" id="adBannerBottom">
            (ê´‘ê³  ìë¦¬) ì„±ê³µ í›„ í•˜ë‹¨ ë°°ë„ˆ
            <small>ì—¬ê¸°ì— ë°°ë„ˆ ê´‘ê³  ì½”ë“œ ë¶™ì´ë©´ ë¨</small>
          </div>
        </div>

        <div class="modalActions" id="msgActions"></div>
      </div>
    </div>

    <!-- âœ… ì¢Œì„/í¬ë„ì•Œ ì¤Œ ì»¨íŠ¸ë¡¤ (ê²Œì„/í¸ì§‘ ê³µìš©) -->
    <div class="zoomUI hidden" id="zoomUI" aria-label="í™•ëŒ€ ì¶•ì†Œ ì»¨íŠ¸ë¡¤">
      <button id="zoomOut" type="button" aria-label="ì¶•ì†Œ">-</button>
      <span id="zoomLabel">100%</span>
      <button id="zoomIn" type="button" aria-label="í™•ëŒ€">+</button>
    </div>

  </div>

<script>
/***************
 * âœ… ê¸°ë³¸ ì¢Œì„ JSON URL (big/mid/small)
 ***************/
const SEAT_JSON_URLS = {
  big:   "https://raw.githubusercontent.com/histyproject-cloud/curtaincall-ticketing/refs/heads/main/big.json",
  mid:   "https://raw.githubusercontent.com/histyproject-cloud/curtaincall-ticketing/refs/heads/main/mid.json",
  small: "https://raw.githubusercontent.com/histyproject-cloud/curtaincall-ticketing/refs/heads/main/small.json",
};

/***************
 * í—¬í¼
 ***************/
function $(sel){ return document.querySelector(sel); }
function $all(sel){ return Array.from(document.querySelectorAll(sel)); }
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function clampInt(v, a, b){
  v = parseInt(v,10);
  if(Number.isNaN(v)) v = a;
  return Math.max(a, Math.min(b, v));
}
function clampNum(v, a, b){
  v = Number(v);
  if(!Number.isFinite(v)) v = a;
  return Math.max(a, Math.min(b, v));
}
function fmtSec(ms){
  const s = Math.max(0, ms/1000);
  return s.toFixed(2);
}

/***************
 * ë¡œì»¬ ì¹´ìš´í„°
 ***************/
const LS = {
  uid: "curtaincall_uid",
  users: "curtaincall_users_local",
  starts: "curtaincall_starts_local",
  settings: "curtaincall_settings_v1",
  snapBig: "cc_snap_big_v1",
  snapMid: "cc_snap_mid_v1",
  snapSmall: "cc_snap_small_v1",
};

function uuid(){
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c=>{
    const r = (Math.random()*16)|0;
    const v = c==="x" ? r : (r&0x3)|0x8;
    return v.toString(16);
  });
}

function initCounters(){
  let uid = localStorage.getItem(LS.uid);
  if(!uid){
    uid = uuid();
    localStorage.setItem(LS.uid, uid);
    const u = parseInt(localStorage.getItem(LS.users) || "0", 10) || 0;
    localStorage.setItem(LS.users, String(u + 1));
  }
  renderCounters();
}
function incStarts(){
  const s = parseInt(localStorage.getItem(LS.starts) || "0", 10) || 0;
  localStorage.setItem(LS.starts, String(s + 1));
  renderCounters();
}
function renderCounters(){
  const starts = parseInt(localStorage.getItem(LS.starts) || "0", 10) || 0;
  const uStarts = $("#uStarts");
  if(uStarts) uStarts.textContent = starts.toLocaleString();
}

/***************
 * ì„¤ì •
 ***************/
function loadSettings(){
  const raw = localStorage.getItem(LS.settings);
  const base = { captcha:"on", countdownSec:10, failRate:0.50, difficulty:"mid" };
  if(!raw) return base;
  try{
    const o = JSON.parse(raw);
    return {
      captcha: (o.captcha==="off" ? "off" : "on"),
      countdownSec: clampInt(o.countdownSec ?? 10, 3, 30),
      failRate: clampNum(o.failRate ?? 0.50, 0.01, 0.99),
      difficulty: (o.difficulty==="high" || o.difficulty==="low" || o.difficulty==="mid") ? o.difficulty : "mid",
    };
  }catch{
    return base;
  }
}
function saveSettings(s){
  localStorage.setItem(LS.settings, JSON.stringify(s));
}

/***************
 * ë‚œì´ë„
 ***************/
function diffKor(){
  const d = app.settings.difficulty || "mid";
  if(d === "high") return "ìƒ";
  if(d === "low") return "í•˜";
  return "ì¤‘";
}
function diffHintText(){
  const d = app.settings.difficulty || "mid";
  if(d === "high") return "ìƒ: ë‚¨ì€ ì¢Œì„ ì ìŒ Â· ëŒ€ê¸°ë²ˆí˜¸ ë¹¡ì…ˆ Â· ì´ì„ ì¢Œ í™•ë¥  ì²´ê°â†‘";
  if(d === "mid")  return "ì¤‘: ë°¸ëŸ°ìŠ¤í˜• Â· ë‚¨ì€ ì¢Œì„/ëŒ€ê¸°ë²ˆí˜¸/ì´ì„ ì¢Œ í™•ë¥  ë³´í†µ";
  return "í•˜: ë‚¨ì€ ì¢Œì„ ë§ìŒ Â· ëŒ€ê¸°ë²ˆí˜¸ ì‰¬ì›€ Â· ì´ì„ ì¢Œ í™•ë¥  ì²´ê°â†“";
}
function renderDiffUI(){
  const d = app.settings.difficulty || "mid";
  $all(".diffBtn").forEach(btn=>{
    btn.classList.toggle("sel", btn.dataset.diff === d);
  });
  const hint = $("#diffHint");
  if(hint) hint.textContent = diffHintText();
}
function targetRemainByDifficulty(){
  const d = app.settings.difficulty || "mid";
  if(d === "high") return 25;
  if(d === "mid") return 40;
  return 100;
}
function applyInitialRemainFixed(grapes, remainTarget){
  const total = grapes.length;
  remainTarget = Math.max(1, Math.min(total, remainTarget));

  grapes.forEach(g => g.alive = false);

  const idxs = Array.from({length: total}, (_,i)=>i);
  for(let i=idxs.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [idxs[i], idxs[j]] = [idxs[j], idxs[i]];
  }
  for(let k=0;k<remainTarget;k++){
    grapes[idxs[k]].alive = true;
  }
  return { remainTarget, soldOutCount: total - remainTarget };
}

/***************
 * âœ… ê´‘ê³  ì»¨í…Œì´ë„ˆ í‘œì‹œ ì œì–´
 ***************/
function setPreStartAdVisible(visible){
  const el = $("#adPreStart");
  if(!el) return;
  el.classList.toggle("hidden", !visible);
}

/***************
 * ìƒíƒœ
 ***************/
const Phase = Object.freeze({
  THEATER:"THEATER",
  DETAIL:"DETAIL",
  COUNTDOWN:"COUNTDOWN",
  READY:"READY",
  WAIT:"WAIT",
  CAL:"CAL",
  CAPTCHA:"CAPTCHA",
  SEATS:"SEATS",
});

/***************
 * âœ… ì¢Œì„ í¸ì§‘ ì ê¸ˆ ë¹„ë²ˆ
 ***************/
const ADMIN_PW = "jolver48@@";

const app = {
  phase: Phase.THEATER,
  settings: loadSettings(),
  selectedTheater: null,

  seatLocked: true,

  readyAt: null,
  bookClickedAt: null,
  captchaShownAt: null,
  captchaPassedAt: null,
  seatsShownAt: null,
  seatsSuccessAt: null,

  seatFailShown: false,

  countdownLeft: 10,
  countdownTimer: null,
  wait: { start:0, timer:null, totalMs:0 },
  pickedDate: null,
  captchaAnswer: "",

  grapes: [],
  grapeTimer: null,

  seatEdit: false,
  seatPoints: [],
  seatKey: null,

  snapGuide: [],
  snapKey: null,

  // âœ… ê¸°ë³¸ ì¢Œì„ ë¡œë“œ ì¤‘ ì¤‘ë³µ fetch ë°©ì§€
  preload: { promise: null },

  view: {
    scale: 1,
    tx: 0,
    ty: 0,
    dragging: false,
    dragStart: {x:0,y:0, tx:0, ty:0},
    pinch: null,
  }
};

function phaseLabel(p){
  switch(p){
    case Phase.THEATER: return "ê·¹ì¥ ì„ íƒ";
    case Phase.DETAIL: return "ì˜ˆë§¤ ìƒì„¸";
    case Phase.COUNTDOWN: return "ì¹´ìš´íŠ¸ë‹¤ìš´";
    case Phase.READY: return "ì˜ˆë§¤ ê°€ëŠ¥";
    case Phase.WAIT: return "ëŒ€ê¸°ì¤‘";
    case Phase.CAL: return "ë‚ ì§œ ì„ íƒ";
    case Phase.CAPTCHA: return "ë³´ì•ˆë¬¸ì";
    case Phase.SEATS: return "í¬ë„ì•Œ";
    default: return "-";
  }
}

/***************
 * âœ… ì ê¸ˆ ë²„íŠ¼ UI ì—…ë°ì´íŠ¸
 ***************/
function updateSeatLockUI(){
  const btn = $("#editSeatsBtn");
  if(!btn) return;
  if(app.seatEdit) return;
  btn.classList.toggle("locked", app.seatLocked);
}

/***************
 * âœ… ì¤Œ UI í‘œì‹œ/ë™ì‘ (ê²Œì„/í¸ì§‘ ê³µìš©)
 ***************/
function updateZoomUI(){
  const z = $("#zoomUI");
  if(!z) return;
  const show = (app.phase === Phase.SEATS);
  z.classList.toggle("hidden", !show);
  if(show){
    const pct = Math.round(app.view.scale * 100);
    $("#zoomLabel").textContent = `${pct}%`;
  }
}

function zoomUISet(delta){
  const next = app.view.scale + delta;
  const rect = boardRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top + rect.height/2;
  zoomAt(cx, cy, next);
  updateZoomUI();
}

function setPhase(p){
  app.phase = p;
  $("#phaseText").textContent = phaseLabel(p);
  showOnly(p);

  if(p===Phase.THEATER) $("#topTitle").textContent = "ì»¤íŠ¼ì½œ (CurtainCall)";
  else if(p===Phase.DETAIL || p===Phase.COUNTDOWN || p===Phase.READY) $("#topTitle").textContent = "ì˜ˆë§¤ í˜ì´ì§€";
  else if(p===Phase.WAIT) $("#topTitle").textContent = "ì˜ˆë§¤ ëŒ€ê¸°";
  else if(p===Phase.CAL) $("#topTitle").textContent = "ë‚ ì§œ ì„ íƒ";
  else if(p===Phase.CAPTCHA) $("#topTitle").textContent = "ë³´ì•ˆë¬¸ì";
  else if(p===Phase.SEATS) $("#topTitle").textContent = "ìë¦¬ ì¡ê¸°";

  setPreStartAdVisible(p === Phase.DETAIL);
  updateZoomUI();

  if(p === Phase.SEATS) updateSeatLockUI();
}

function showOnly(phase){
  const map = {
    [Phase.THEATER]:"scrTheater",
    [Phase.DETAIL]:"scrDetail",
    [Phase.COUNTDOWN]:"scrDetail",
    [Phase.READY]:"scrDetail",
    [Phase.WAIT]:"scrWait",
    [Phase.CAL]:"scrCal",
    [Phase.CAPTCHA]:"scrCaptcha",
    [Phase.SEATS]:"scrSeats",
  };
  const showId = map[phase];
  $all(".screen").forEach(el=>el.classList.remove("show"));
  $("#"+showId).classList.add("show");

  if(phase===Phase.THEATER || phase===Phase.DETAIL || phase===Phase.COUNTDOWN || phase===Phase.READY){
    $("#bottomBar").style.display = "block";
  }else{
    $("#bottomBar").style.display = "none";
  }

  $("#content").scrollTop = 0;
}

/***************
 * í•˜ë‹¨ ë²„íŠ¼
 ***************/
function setMainButton(text, enabled){
  const btn = $("#mainBtn");
  btn.textContent = text;
  btn.disabled = !enabled;
  btn.classList.toggle("ready", !!enabled);
}

/***************
 * ê·¹ì¥ ì„ íƒ â†’ ìƒì„¸ ë°˜ì˜
 ***************/
function applyTheaterToDetail(){
  const t = app.selectedTheater;
  const place =
    t==="big" ? "ëŒ€ê·¹ì¥" :
    t==="mid" ? "ì¤‘ê·¹ì¥" :
    t==="small" ? "ì†Œê·¹ì¥" : "-";

  $("#detailPlace").textContent = `CurtainCall ${place}`;
  $("#detailTitle").textContent = `CurtainCall Musical (${place})`;
  $("#detailBadge").textContent = "ë®¤ì§€ì»¬";
}

function theaterName(t){
  if(t==="big") return "ëŒ€ê·¹ì¥";
  if(t==="mid") return "ì¤‘ê·¹ì¥";
  if(t==="small") return "ì†Œê·¹ì¥";
  return "-";
}

/***************
 * ì¢Œì„ ì´ë¯¸ì§€/ì €ì¥í‚¤
 ***************/
function getSeatMapInfo(){
  const t = app.selectedTheater || "big";
  const mapSrc =
    t==="big" ? "theater_big.png" :
    t==="mid" ? "theater_mid.png" :
    "theater_small.png";

  const seatKey =
    t==="big" ? "cc_seats_big_v1" :
    t==="mid" ? "cc_seats_mid_v1" :
    "cc_seats_small_v1";

  const snapKey =
    t==="big" ? LS.snapBig :
    t==="mid" ? LS.snapMid :
    LS.snapSmall;

  const url = SEAT_JSON_URLS[t] || SEAT_JSON_URLS.big;

  return { mapSrc, seatKey, snapKey, url };
}

/***************
 * âœ… ê¸°ë³¸ ì¢Œì„ JSONì„ ë°›ì•„ì„œ localStorageì— ì €ì¥ (ì²˜ìŒ 1íšŒ)
 * - í˜•ì‹ ì§€ì›:
 *   1) [ {x,y}, ... ]
 *   2) { seatPoints:[...], snapGuide:[...] } (export í˜•íƒœ)
 ***************/
async function fetchDefaultSeatsIfNeeded(){
  const { seatKey, snapKey, url } = getSeatMapInfo();

  // ì´ë¯¸ ë¡œì»¬ì— ìˆìœ¼ë©´ ìŠ¤í‚µ
  const existing = localStorage.getItem(seatKey);
  if(existing){
    try{
      const arr = JSON.parse(existing);
      if(Array.isArray(arr) && arr.length) return true;
    }catch{}
  }

  try{
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("http");
    const txt = await res.text();
    const data = JSON.parse(txt);

    let seatPoints = [];
    let snapGuide = [];

    if(Array.isArray(data)){
      seatPoints = data;
    }else if(data && Array.isArray(data.seatPoints)){
      seatPoints = data.seatPoints;
      if(Array.isArray(data.snapGuide)) snapGuide = data.snapGuide;
      // í˜¹ì‹œ fieldëª…ì´ seatpoints ê°™ì€ ë³€í˜•ì´ë©´ í™•ì¥ ê°€ëŠ¥
    }else if(data && Array.isArray(data.points)){
      seatPoints = data.points;
    }

    // ì¢Œí‘œ í˜•íƒœ ê²€ì¦(ëŒ€ì¶©)
    seatPoints = seatPoints
      .filter(p => p && typeof p.x === "number" && typeof p.y === "number")
      .map(p => ({ x: p.x, y: p.y }));

    snapGuide = (Array.isArray(snapGuide) ? snapGuide : [])
      .filter(p => p && typeof p.x === "number" && typeof p.y === "number")
      .map(p => ({ x: p.x, y: p.y }));

    if(seatPoints.length){
      localStorage.setItem(seatKey, JSON.stringify(seatPoints));
      localStorage.setItem(snapKey, JSON.stringify(snapGuide));
      return true;
    }
    return false;
  }catch{
    return false;
  }
}

/***************
 * âœ… ì¢Œì„/ìŠ¤ëƒ… ë¡œë“œ
 ***************/
function loadSeatPoints(){
  const { mapSrc, seatKey, snapKey } = getSeatMapInfo();
  app.seatKey = seatKey;
  app.snapKey = snapKey;

  const img = $("#seatMapImg");
  if(img) img.src = mapSrc;

  const raw = localStorage.getItem(seatKey);
  let points = [];
  if(raw){
    try{
      const arr = JSON.parse(raw);
      if(Array.isArray(arr)) points = arr;
    }catch{}
  }

  const sg = localStorage.getItem(snapKey);
  app.snapGuide = [];
  if(sg){
    try{
      const arr = JSON.parse(sg);
      if(Array.isArray(arr)) app.snapGuide = arr;
    }catch{}
  }

  return points;
}
function saveSeatPoints(){
  if(!app.seatKey) return;
  localStorage.setItem(app.seatKey, JSON.stringify(app.seatPoints));
}
function saveSnapGuide(){
  if(!app.snapKey) return;
  localStorage.setItem(app.snapKey, JSON.stringify(app.snapGuide));
}

/***************
 * âœ… ì¢Œì„ì´ ë¹„ì–´ìˆìœ¼ë©´ ì›ê²© JSONì—ì„œ ìë™ ë¡œë“œ í›„ ë‹¤ì‹œ ë¡œë“œ
 ***************/
async function ensureSeatPointsLoaded(){
  // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
  if(app.preload.promise) return app.preload.promise;

  app.preload.promise = (async ()=>{
    // 1) ë¨¼ì € í˜„ì¬ ë¡œì»¬ ë¡œë“œ
    let pts = loadSeatPoints();
    if(pts && pts.length){
      app.seatPoints = pts;
      return true;
    }

    // 2) ë¡œì»¬ì— ì—†ìœ¼ë©´ ê¸°ë³¸ JSON fetch
    const ok = await fetchDefaultSeatsIfNeeded();

    // 3) ë‹¤ì‹œ ë¡œë“œ
    pts = loadSeatPoints();
    app.seatPoints = pts;

    return !!(ok && pts && pts.length);
  })();

  const result = await app.preload.promise;
  app.preload.promise = null;
  return result;
}

/***************
 * ì˜ˆë§¤ ìƒì„¸ íë¦„
 ***************/
function openStartOverlay(){
  renderDiffUI();
  $("#startOverlay").classList.add("show");
}
function closeStartOverlay(){ $("#startOverlay").classList.remove("show"); }

function startCountdown(){
  stopCountdown();
  app.countdownLeft = app.settings.countdownSec;
  setPhase(Phase.COUNTDOWN);
  setMainButton(formatMMSS(app.countdownLeft), false);

  app.countdownTimer = setInterval(()=>{
    app.countdownLeft -= 1;
    if(app.countdownLeft <= 0){
      stopCountdown();
      setPhase(Phase.READY);
      setMainButton("ì˜ˆë§¤í•˜ê¸°", true);
      app.readyAt = performance.now();
      return;
    }
    setMainButton(formatMMSS(app.countdownLeft), false);
  }, 1000);
}
function stopCountdown(){
  if(app.countdownTimer){
    clearInterval(app.countdownTimer);
    app.countdownTimer = null;
  }
}
function formatMMSS(sec){
  const s = Math.max(0, sec|0);
  const mm = String(Math.floor(s/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${mm}:${ss}`;
}

function onClickBook(){
  if(app.phase !== Phase.READY) return;

  app.bookClickedAt = performance.now();

  const delta = Math.max(0, app.bookClickedAt - (app.readyAt ?? app.bookClickedAt));
  const waitNum = computeWaitNumber(delta/1000);
  const people = computeWaitPeople(waitNum);

  $("#waitPeople").textContent = people.toLocaleString() + "ëª…";
  $("#waitNum").textContent = String(waitNum);
  $("#waitSmall").textContent = String(waitNum);
  $("#waitBar").style.width = "0%";

  setPhase(Phase.WAIT);
  runWait(waitNum);
}

function computeWaitNumber(deltaSec){
  const d = app.settings.difficulty || "mid";
  const make = (base)=> base + randInt(0, 999);

  if(d === "high"){
    if(deltaSec <= 0.10) return make(2000);
    if(deltaSec <= 0.20) return make(4000);
    if(deltaSec <= 0.30) return make(6000);
    if(deltaSec <= 0.40) return make(8000);
    if(deltaSec <= 0.50) return make(10000);
    if(deltaSec <= 0.60) return make(12000);
    return make(14000);
  }

  if(d === "mid"){
    if(deltaSec <= 0.10) return make(1000);
    if(deltaSec <= 0.20) return make(3000);
    if(deltaSec <= 0.30) return make(5000);
    if(deltaSec <= 0.50) return make(6000);
    if(deltaSec <= 0.60) return make(8000);
    if(deltaSec <= 0.70) return make(10000);
    return make(12000);
  }

  if(deltaSec <= 0.10) return make(500);
  if(deltaSec <= 0.20) return make(1000);
  if(deltaSec <= 0.30) return make(2000);
  if(deltaSec <= 0.40) return make(3000);
  if(deltaSec <= 0.50) return make(4000);
  if(deltaSec <= 0.60) return make(5000);
  return make(6000);
}

function computeWaitPeople(waitNum){
  return waitNum + randInt(8000, 35000);
}

function runWait(startNum){
  stopWait();
  app.wait.start = startNum;

  const bucket = Math.max(1, Math.min(12, Math.floor(startNum / 1000)));
  const totalSec = 2.8 + bucket * 0.9 + Math.random()*1.8;
  app.wait.totalMs = totalSec * 1000;

  const t0 = performance.now();
  app.wait.timer = setInterval(()=>{
    const t = performance.now();
    const progress = Math.min(1, (t - t0) / app.wait.totalMs);
    const remain = Math.max(0, Math.round(app.wait.start * (1 - progress)));

    $("#waitNum").textContent = String(remain);
    $("#waitSmall").textContent = String(remain);
    $("#waitBar").style.width = (progress*100).toFixed(1) + "%";

    if(progress >= 1){
      stopWait();
      enterCalendar();
    }
  }, 120);
}
function stopWait(){
  if(app.wait.timer){
    clearInterval(app.wait.timer);
    app.wait.timer = null;
  }
}

/***************
 * ë‹¬ë ¥
 ***************/
function enterCalendar(){
  setPhase(Phase.CAL);
  app.pickedDate = null;
  buildCalendar(2026, 3, 30);
}
function buildCalendar(year, month, days){
  $("#calYM").textContent = `${year}.${String(month).padStart(2,"0")}`;
  const grid = $("#calGrid");
  grid.innerHTML = "";

  const offset = 2;
  for(let i=0;i<offset;i++){
    const d = document.createElement("div");
    d.className = "day off";
    d.textContent = "";
    grid.appendChild(d);
  }
  for(let day=1; day<=days; day++){
    const d = document.createElement("div");
    d.className = "day";
    d.textContent = String(day);
    d.addEventListener("click", ()=>{
      $all(".day").forEach(x=>x.classList.remove("sel"));
      d.classList.add("sel");

      app.pickedDate = `${year}.${String(month).padStart(2,"0")}.${String(day).padStart(2,"0")}`;

      setTimeout(()=>{
        if(app.settings.captcha === "off") enterSeats(true);
        else enterCaptcha();
      }, 160);
    });
    grid.appendChild(d);
  }
}

/***************
 * ë³´ì•ˆë¬¸ì
 ***************/
function enterCaptcha(){
  setPhase(Phase.CAPTCHA);
  app.captchaShownAt = performance.now();
  regenCaptcha();
  $("#capInput").value = "";
  $("#capInput").focus({preventScroll:true});
  $("#capHint").textContent = "ì´ë¯¸ì§€ì— ë³´ì´ëŠ” ë¬¸ìë¥¼ ê·¸ëŒ€ë¡œ ì…ë ¥í•˜ê³  í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
}
function regenCaptcha(){
  app.captchaAnswer = makeCaptchaText(5);
  $("#capText").textContent = app.captchaAnswer;
}
function makeCaptchaText(len){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let s = "";
  for(let i=0;i<len;i++){
    s += chars[Math.floor(Math.random()*chars.length)];
  }
  return s;
}
function onCaptchaOk(){
  const val = ($("#capInput").value || "").trim().toUpperCase();
  if(val === app.captchaAnswer){
    app.captchaPassedAt = performance.now();
    enterSeats(true);
  }else{
    const card = $("#capCard");
    card.classList.remove("shake");
    void card.offsetWidth;
    card.classList.add("shake");
    $("#capHint").textContent = "ë³´ì•ˆë¬¸ìê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.";
    regenCaptcha();
    $("#capInput").value = "";
    $("#capInput").focus({preventScroll:true});
  }
}

/***************
 * âœ… ì¤Œ/ë“œë˜ê·¸ ìœ í‹¸
 ***************/
function applyViewTransform(){
  const vp = $("#seatViewport");
  const v = app.view;
  vp.style.transform = `translate(${v.tx}px, ${v.ty}px) scale(${v.scale})`;
}
function resetView(){
  app.view.scale = 1;
  app.view.tx = 0;
  app.view.ty = 0;
  applyViewTransform();
  updateZoomUI();
}
function boardRect(){
  return $("#seatBoard").getBoundingClientRect();
}
function clientToBoardPercent(clientX, clientY){
  const rect = boardRect();
  const v = app.view;

  const localX = (clientX - rect.left - v.tx) / v.scale;
  const localY = (clientY - rect.top  - v.ty) / v.scale;

  const x = (localX / rect.width)  * 100;
  const y = (localY / rect.height) * 100;
  return { x, y };
}
function clampView(){
  const rect = boardRect();
  const v = app.view;
  const minScale = 0.6;
  const maxScale = 4;
  v.scale = clampNum(v.scale, minScale, maxScale);

  const maxTx = rect.width  * (v.scale - 1);
  const maxTy = rect.height * (v.scale - 1);

  v.tx = clampNum(v.tx, -maxTx - 40, 40);
  v.ty = clampNum(v.ty, -maxTy - 40, 40);
}
function zoomAt(clientX, clientY, nextScale){
  const rect = boardRect();
  const v = app.view;

  const prevScale = v.scale;
  nextScale = clampNum(nextScale, 0.6, 4);

  const px = clientX - rect.left;
  const py = clientY - rect.top;

  const worldX = (px - v.tx) / prevScale;
  const worldY = (py - v.ty) / prevScale;

  v.scale = nextScale;
  v.tx = px - worldX * nextScale;
  v.ty = py - worldY * nextScale;

  clampView();
  applyViewTransform();
  updateZoomUI();
}

/***************
 * âœ… ìŠ¤ëƒ…
 ***************/
function dist(a,b){
  const dx = a.x-b.x, dy=a.y-b.y;
  return Math.sqrt(dx*dx+dy*dy);
}
function snapToGuide(p){
  if(!app.snapGuide || app.snapGuide.length === 0) return p;

  let best = null;
  let bestD = Infinity;
  for(const g of app.snapGuide){
    const d = dist(p, g);
    if(d < bestD){
      bestD = d;
      best = g;
    }
  }
  if(best && bestD <= 2.2) return { x: best.x, y: best.y };
  return p;
}
function renderSnapGuide(){
  const vp = $("#seatViewport");
  Array.from(vp.querySelectorAll(".snapGuide")).forEach(el=>el.remove());
  if(!app.seatEdit) return;
  if(!app.snapGuide || app.snapGuide.length === 0) return;

  const show = app.snapGuide.slice(0, 350);
  for(const p of show){
    const el = document.createElement("div");
    el.className = "snapGuide";
    el.style.left = p.x + "%";
    el.style.top  = p.y + "%";
    vp.appendChild(el);
  }
}

/**
 * ìŠ¤ëƒ… ê°€ì´ë“œ ìƒì„± (ê°„ì´ ì›í˜• ê°ì§€)
 */
async function buildSnapGuideFromImage(){
  const img = $("#seatMapImg");
  if(!img || !img.complete){
    showMsg("ì ê¹!", "ì¢Œì„ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ì•¼. ì´ë¯¸ì§€ê°€ ëœ¬ ë‹¤ìŒ ë‹¤ì‹œ ëˆŒëŸ¬ì¤˜!", [
      { text:"í™•ì¸", kind:"primary", onClick: hideMsg }
    ]);
    return;
  }

  const size = 600;
  const cvs = document.createElement("canvas");
  cvs.width = size; cvs.height = size;
  const ctx = cvs.getContext("2d", { willReadFrequently: true });

  ctx.clearRect(0,0,size,size);
  const iw = img.naturalWidth || 1;
  const ih = img.naturalHeight || 1;
  const scale = Math.min(size/iw, size/ih);
  const dw = iw*scale, dh = ih*scale;
  const dx = (size - dw)/2;
  const dy = (size - dh)/2;
  ctx.drawImage(img, dx, dy, dw, dh);

  const id = ctx.getImageData(0,0,size,size);
  const data = id.data;

  const gray = new Float32Array(size*size);
  for(let i=0;i<size*size;i++){
    const r = data[i*4], g = data[i*4+1], b = data[i*4+2];
    gray[i] = (0.2126*r + 0.7152*g + 0.0722*b);
  }
  const grad = new Float32Array(size*size);
  for(let y=1;y<size-1;y++){
    for(let x=1;x<size-1;x++){
      const i = y*size + x;
      const gx = Math.abs(gray[i+1] - gray[i-1]);
      const gy = Math.abs(gray[i+size] - gray[i-size]);
      grad[i] = gx + gy;
    }
  }

  const angles = [];
  for(let k=0;k<16;k++){
    const a = (Math.PI*2*k)/16;
    angles.push({cx: Math.cos(a), sy: Math.sin(a)});
  }

  const candidates = [];
  const step = 5;
  const r = 11;
  const margin = 20;

  for(let y=margin; y<size-margin; y+=step){
    for(let x=margin; x<size-margin; x+=step){
      let score = 0;
      for(const a of angles){
        const rx = Math.round(x + a.cx*r);
        const ry = Math.round(y + a.sy*r);
        const idx = ry*size + rx;
        score += grad[idx];
      }
      if(score > 220){
        candidates.push({x,y,score});
      }
    }
  }

  candidates.sort((a,b)=>b.score-a.score);

  const picked = [];
  const minDist = 14;
  for(const c of candidates){
    if(picked.length >= 900) break;
    let ok = true;
    for(const p of picked){
      const dx2 = p.x - c.x;
      const dy2 = p.y - c.y;
      if((dx2*dx2 + dy2*dy2) < (minDist*minDist)){
        ok = false; break;
      }
    }
    if(ì˜¤ì¼€ì´) picked.push(c);
  }

  const guide = [];
  for(const p of picked){
    if(p.x < dx || p.x > dx+dw || p.y < dy || p.y > dy+dh) continue;

    const nx = (p.x - dx) / dw;
    const ny = (p.y - dy) / dh;

    const bx = ((dx + nx*dw) / size) * 100;
    const by = ((dy + ny*dh) / size) * 100;

    guide.push({x: bx, y: by});
  }

  app.snapGuide = guide;
  saveSnapGuide();
  renderSnapGuide();

  showMsg("ìŠ¤ëƒ… ê°€ì´ë“œ ìƒì„± ì™„ë£Œ", `ê°€ì´ë“œ ${guide.length}ê°œ ë§Œë“¤ì—ˆì–´!\nì´ì œ ì¢Œì„ ì°ì„ ë•Œ ê·¼ì²˜ ì› ì¤‘ì‹¬ìœ¼ë¡œ ìë™ ë³´ì •ë¼.`, [
    { text:"í™•ì¸", kind:"primary", onClick: hideMsg }
  ]);
}

/***************
 * âœ… ì¢Œì„ í¸ì§‘ ëª¨ë“œ
 ***************/
function setSeatEditMode(on){
  app.seatEdit = on;

  $("#saveSeatsBtn").style.display = on ? "inline-grid" : "none";
  $("#resetSeatsBtn").style.display = on ? "inline-grid" : "none";
  $("#snapBuildBtn").style.display = on ? "inline-grid" : "none";
  $("#zoomResetBtn").style.display = on ? "inline-grid" : "none";

  $("#exportSeatsBtn").style.display = on ? "inline-grid" : "none";
  $("#importSeatsBtn").style.display = on ? "inline-grid" : "none";

  if(on){
    $("#editSeatsBtn").classList.remove("locked");
    $("#editSeatsBtn").textContent = "í¸ì§‘ì¤‘";
    stopGrapeDisappear();
    $("#seatHeaderText").textContent = "* í¸ì§‘ëª¨ë“œ: ë“œë˜ê·¸ ì´ë™ / íœ  ì¤Œ / í´ë¦­=ì¢Œì„ ì¶”ê°€ / Shift+í´ë¦­=ê·¼ì²˜ ì¢Œì„ ì‚­ì œ / ì €ì¥ ëˆ„ë¥´ë©´ ì˜êµ¬ ì €ì¥!";
    $("#seatSub").textContent = `ê·¹ì¥: ${theaterName(app.selectedTheater)} Â· ì¢Œì„ì„ ì°ì–´ì¤˜`;
    resetView();
    renderSnapGuide();
    renderSeatDotsForEdit();
  }else{
    enterSeats(false);
  }
}

function seatBoardClickToEdit(e){
  if(!app.seatEdit) return;
  if(e.target && (e.target.closest && e.target.closest(".seatDot"))) return;

  const p0 = clientToBoardPercent(e.clientX, e.clientY);
  const p = snapToGuide(p0);

  if(e.shiftKey){
    if(app.seatPoints.length === 0) return;
    let bestIdx = -1;
    let bestDist = Infinity;

    app.seatPoints.forEach((s, idx)=>{
      const d = dist(s, p);
      if(d < bestDist){
        bestDist = d;
        bestIdx = idx;
      }
    });

    if(bestIdx !== -1 && bestDist <= 2.8){
      app.seatPoints.splice(bestIdx, 1);
      renderSeatDotsForEdit();
    }
    return;
  }

  const tooClose = app.seatPoints.some(s => dist(s, p) < 1.0);
  if(tooClose) return;

  app.seatPoints.push({x: p.x, y: p.y});
  renderSeatDotsForEdit();
}

function renderSeatDotsForEdit(){
  const vp = $("#seatViewport");
  Array.from(vp.querySelectorAll(".seatDot")).forEach(el=>el.remove());

  app.seatPoints.forEach((p, idx)=>{
    const dot = document.createElement("div");
    dot.className = "seatDot playable edit";
    dot.style.left = p.x + "%";
    dot.style.top  = p.y + "%";

    dot.addEventListener("click", (ev)=>{
      ev.stopPropagation();
      if(ev.shiftKey){
        app.seatPoints.splice(idx, 1);
        renderSeatDotsForEdit();
      }
    });

    vp.appendChild(dot);
  });

  $("#remainCount").textContent = String(app.seatPoints.length);
  renderSnapGuide();
}

/***************
 * âœ… í¬ë„ì•Œ(ì¢Œì„) ê²Œì„
 ***************/
function enterSeats(resetAlive){
  // asyncê°€ í•„ìš”í•´ì„œ ë‚´ë¶€ì—ì„œ ì‹¤í–‰
  (async ()=>{
    setPhase(Phase.SEATS);

    app.seatFailShown = false;

    app.seatEdit = false;
    $("#saveSeatsBtn").style.display = "none";
    $("#resetSeatsBtn").style.display = "none";
    $("#snapBuildBtn").style.display = "none";
    $("#zoomResetBtn").style.display = "none";

    $("#exportSeatsBtn").style.display = "none";
    $("#importSeatsBtn").style.display = "none";

    $("#editSeatsBtn").textContent = "ì¢Œì„ì„¤ì •";
    updateSeatLockUI();

    resetView();

    // âœ… ì—¬ê¸°ì„œ ìë™ ë¡œë“œ ë³´ì¥
    await ensureSeatPointsLoaded();

    let size;
    if(app.selectedTheater === "big") size = "4px";
    else if(app.selectedTheater === "mid") size = "7px";
    else size = "10px";
    document.documentElement.style.setProperty('--dotSize', size);

    app.seatsShownAt = performance.now();
    app.seatsSuccessAt = null;

    $("#seatTitle").textContent = "ìë¦¬ ì¡ê¸°";
    $("#seatSub").textContent = `ë‚ ì§œ: ${app.pickedDate ?? "-"} Â· ë‚œì´ë„: ${diffKor()}`;

    const vp = $("#seatViewport");
    Array.from(vp.querySelectorAll(".seatDot")).forEach(el=>el.remove());
    Array.from(vp.querySelectorAll(".snapGuide")).forEach(el=>el.remove());

    if(!app.seatPoints || app.seatPoints.length === 0){
      stopGrapeDisappear();
      app.grapes = [];
      $("#seatHeaderText").textContent = "* ì•„ì§ ì¢Œì„ì´ ì—†ì–´! (ê¸°ë³¸ ì¢Œì„ ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ì‹¤íŒ¨í–ˆì„ ìˆ˜ë„ ìˆì–´)\nâ€˜ì¢Œì„ì„¤ì •â€™ ëˆŒëŸ¬ì„œ ë™ê·¸ë¼ë¯¸ë“¤ë¶€í„° ì°ê³  ì €ì¥í•´ì¤˜.";
      $("#remainCount").textContent = "0";
      return;
    }

    app.grapes = app.seatPoints.map((p, i)=>({ id:"s"+i, x:p.x, y:p.y, alive:true }));

    const remainTarget = targetRemainByDifficulty();
    applyInitialRemainFixed(app.grapes, remainTarget);

    $("#seatHeaderText").textContent = "";

    renderGrapes();
    startGrapeDisappear();
  })();
}

function renderGrapes(){
  const vp = $("#seatViewport");
  Array.from(vp.querySelectorAll(".seatDot")).forEach(el=>el.remove());

  let aliveCount = 0;

  app.grapes.forEach((g)=>{
    const dot = document.createElement("div");
    dot.className = "seatDot" + (g.alive ? " playable" : " off");
    dot.style.left = g.x + "%";
    dot.style.top  = g.y + "%";

    if(g.alive){
      aliveCount++;
      dot.addEventListener("click", (ev)=>{
        ev.stopPropagation();
        if(app.seatEdit) return;

        if(Math.random() < app.settings.failRate){
          showMsg("ì´ì„ ì¢Œì…ë‹ˆë‹¤", "ì´ë¯¸ ì„ íƒëœ ì¢Œì„ì´ì—ìš”.\nì°½ì„ ë‹«ê³  ë‹¤ë¥¸ ìë¦¬ë¥¼ ê³„ì† ì‹œë„í•˜ì„¸ìš”.", [
            { text:"ë‹«ê¸°", kind:"primary", onClick: hideMsg }
          ]);
          return;
        }

        g.alive = false;
        app.seatsSuccessAt = performance.now();
        stopGrapeDisappear();
        renderGrapes();
        showSuccessModal();
      });
    }
    vp.appendChild(dot);
  });

  $("#remainCount").textContent = String(aliveCount);

  if(!app.seatEdit && aliveCount === 0 && !app.seatsSuccessAt && !app.seatFailShown){
    stopGrapeDisappear();
    showSeatFailModal("ë‚¨ì€ í¬ë„ì•Œì´ ëª¨ë‘ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤.\n(ë‹¤ë¥¸ ì‚¬ëŒì´ ë¨¼ì € ë‹¤ ê°€ì ¸ê°”ëŒ€â€¦)");
  }
}

function startGrapeDisappear(){
  stopGrapeDisappear();

  const loop = ()=>{
    const delay = 200 + Math.random()*300;
    app.grapeTimer = setTimeout(()=>{
      removeTwoGrapes();
      loop();
    }, delay);
  };
  loop();
}
function stopGrapeDisappear(){
  if(app.grapeTimer){
    clearTimeout(app.grapeTimer);
    app.grapeTimer = null;
  }
}
function removeTwoGrapes(){
  if(app.seatEdit) return;

  const alive = app.grapes.filter(x=>x.alive);
  if(alive.length === 0){
    renderGrapes();
    return;
  }

  for(let i=0;i<2;i++){
    if(alive.length === 0) break;
    const idx = randInt(0, alive.length-1);
    const pick = alive[idx];
    pick.alive = false;
    alive.splice(idx, 1);
  }

  renderGrapes();
}

/***************
 * âœ… ì‹¤íŒ¨ ëª¨ë‹¬
 ***************/
function showSeatFailModal(reasonText){
  if(app.seatFailShown) return;
  app.seatFailShown = true;

  $("#successAds").style.display = "none";

  const lines = [];
  lines.push("ì¢Œì„ì´ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.");
  if(reasonText){
    lines.push("");
    lines.push(reasonText);
  }
  lines.push("");
  lines.push("ë‹¤ì‹œ ì‹œë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");

  showMsg("ì‹¤íŒ¨!", lines.join("\n"), [
    { text:"ì²˜ìŒìœ¼ë¡œ", kind:"primary", onClick: ()=>{ hideMsg(); resetToTheater(); } },
    { text:"ë³´ì•ˆë¬¸ìë¶€í„°", kind:"", onClick: ()=>{ hideMsg(); stopGrapeDisappear(); enterCaptcha(); } },
    { text:"ìë¦¬ ì¡ê¸°ë§Œ ë‹¤ì‹œ í•˜ê¸°", kind:"", onClick: ()=>{ hideMsg(); stopGrapeDisappear(); enterSeats(true); } }
  ]);
}

/***************
 * ì„±ê³µ ëª¨ë‹¬
 ***************/
function showSuccessModal(){
  const totalMs = (app.seatsSuccessAt && app.bookClickedAt) ? (app.seatsSuccessAt - app.bookClickedAt) : null;
  const bookMs  = (app.bookClickedAt && app.readyAt) ? (app.bookClickedAt - app.readyAt) : null;
  const capMs   = (app.captchaPassedAt && app.captchaShownAt) ? (app.captchaPassedAt - app.captchaShownAt) : null;
  const seatMs  = (app.seatsSuccessAt && app.seatsShownAt) ? (app.seatsSuccessAt - app.seatsShownAt) : null;

  const lines = [];
  lines.push("ì¢Œì„ ì„ íƒì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!");
  lines.push("");
  lines.push("ê¸°ë¡");
  lines.push(`- ì´ ì‹œê°„(ì˜ˆë§¤â†’í¬ë„ì•Œ ì„±ê³µ): ${totalMs===null ? "-" : fmtSec(totalMs)}ì´ˆ`);
  lines.push(`- ì˜ˆë§¤í•˜ê¸° í´ë¦­: ${bookMs===null ? "-" : fmtSec(bookMs)}ì´ˆ`);
  lines.push(`- ë³´ì•ˆë¬¸ì ì…ë ¥: ${capMs===null ? "-" : fmtSec(capMs)}ì´ˆ`);
  lines.push(`- í¬ë„ì•Œ ì„±ê³µ: ${seatMs===null ? "-" : fmtSec(seatMs)}ì´ˆ`);

  $("#successAds").style.display = "block";

  showMsg("ì„±ê³µ!", lines.join("\n"), [
    { text:"ì²˜ìŒìœ¼ë¡œ", kind:"primary", onClick: ()=>{ hideMsg(); resetToTheater(); } },
    { text:"ë³´ì•ˆë¬¸ìë¶€í„° ë‹¤ì‹œ í•˜ê¸°", kind:"", onClick: ()=>{ hideMsg(); stopGrapeDisappear(); enterCaptcha(); } },
    { text:"í¬ë„ì•Œ ë‹¤ì‹œ", kind:"", onClick: ()=>{ hideMsg(); stopGrapeDisappear(); enterSeats(true); } }
  ]);
}

/***************
 * ë©”ì‹œì§€ ëª¨ë‹¬
 ***************/
function showMsg(title, body, actions){
  $("#msgTitle").textContent = title;
  $("#msgBody").textContent = body;

  const wrap = $("#msgActions");
  wrap.innerHTML = "";

  const btns = actions && actions.length ? actions : [{ text:"í™•ì¸", kind:"primary", onClick: hideMsg }];
  btns.forEach(b=>{
    const btn = document.createElement("button");
    btn.className = "btn" + (b.kind==="primary" ? " primary" : "");
    btn.textContent = b.text;
    btn.addEventListener("click", b.onClick || hideMsg);
    wrap.appendChild(btn);
  });

  $("#msgOverlay").classList.add("show");
}
function hideMsg(){
  $("#msgOverlay").classList.remove("show");
  $("#successAds").style.display = "none";

  const box = $("#transferBox");
  if(box) box.style.display = "none";
  const ta = $("#transferArea");
  if(ta) ta.value = "";
}

/***********************
 * âœ… ì¢Œì„ ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°
 ***********************/
function getTransferPayload(){
  const { seatKey, snapKey } = getSeatMapInfo();

  const seatRaw = JSON.stringify(
    (app.seatPoints && app.seatPoints.length) ? app.seatPoints : (JSON.parse(localStorage.getItem(seatKey) || "[]"))
  );
  const snapRaw = JSON.stringify(
    (app.snapGuide && app.snapGuide.length) ? app.snapGuide : (JSON.parse(localStorage.getItem(snapKey) || "[]"))
  );

  const payload = {
    app: "CurtainCall",
    type: "seat_transfer",
    version: 1,
    theater: app.selectedTheater || "big",
    savedAt: new Date().toISOString(),
    seatPoints: JSON.parse(seatRaw),
    snapGuide: JSON.parse(snapRaw),
  };
  return payload;
}

async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch{
    return false;
  }
}

function openExportModal(){
  if(app.phase !== Phase.SEATS){
    showMsg("ì•ˆë‚´", "ì¢Œì„ í™”ë©´ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´.", [
      { text:"í™•ì¸", kind:"primary", onClick: hideMsg }
    ]);
    return;
  }

  const payload = getTransferPayload();
  const text = JSON.stringify(payload);

  $("#successAds").style.display = "none";
  $("#transferBox").style.display = "block";
  $("#transferArea").value = text;

  showMsg("ì¢Œì„ ë‚´ë³´ë‚´ê¸°", "ì•„ë˜ JSONì„ ë³µì‚¬í•´ì„œ ì €ì¥í•´ë‘¬.\n(ê°€ëŠ¥í•˜ë©´ ìë™ìœ¼ë¡œ í´ë¦½ë³´ë“œì—ë„ ë³µì‚¬í•´ë‘˜ê²Œ)", [
    {
      text:"ìë™ ë³µì‚¬",
      kind:"primary",
      onClick: async ()=>{
        const ok = await copyToClipboard($("#transferArea").value);
        if(ì˜¤ì¼€ì´) alert("í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆì–´!");
        else alert("ìë™ ë³µì‚¬ ì‹¤íŒ¨! ì•„ë˜ ì¹¸ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ Ctrl+C í•´ì¤˜.");
      }
    },
    { text:"ë‹«ê¸°", kind:"", onClick: hideMsg }
  ]);
}

function openImportModal(){
  if(app.phase !== Phase.SEATS){
    showMsg("ì•ˆë‚´", "ì¢Œì„ í™”ë©´ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´.", [
      { text:"í™•ì¸", kind:"primary", onClick: hideMsg }
    ]);
    return;
  }

  $("#successAds").style.display = "none";
  $("#transferBox").style.display = "block";
  $("#transferArea").value = "";

  showMsg("ì¢Œì„ ê°€ì ¸ì˜¤ê¸°", "ì €ì¥í•´ë‘” JSONì„ ì•„ë˜ ì¹¸ì— ë¶™ì—¬ë„£ê³  â€˜ê°€ì ¸ì˜¤ê¸° ì ìš©â€™ì„ ëˆ„ë¥´ë©´ ë.", [
    {
      text:"ê°€ì ¸ì˜¤ê¸° ì ìš©",
      kind:"primary",
      onClick: ()=>{
        try{
          const text = ($("#transferArea").value || "").trim();
          if(!text) throw new Error("empty");

          const obj = JSON.parse(text);
          if(!obj || obj.type !== "seat_transfer" || !Array.isArray(obj.seatPoints)){
            throw new Error("format");
          }

          const { seatKey, snapKey } = getSeatMapInfo();
          localStorage.setItem(seatKey, JSON.stringify(obj.seatPoints));
          localStorage.setItem(snapKey, JSON.stringify(Array.isArray(obj.snapGuide) ? obj.snapGuide : []));

          app.seatPoints = obj.seatPoints;
          app.snapGuide = Array.isArray(obj.snapGuide) ? obj.snapGuide : [];

          hideMsg();
          enterSeats(true);

          showMsg("ì™„ë£Œ", `ì¢Œì„ ${obj.seatPoints.length}ê°œë¥¼ ê°€ì ¸ì™”ì–´!`, [
            { text:"í™•ì¸", kind:"primary", onClick: hideMsg }
          ]);
        }catch(e){
          showMsg("ì˜¤ë¥˜", "ê°€ì ¸ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆì–´.\nJSONì´ ë§ëŠ”ì§€(ì¤‘ê°„ì— ì˜ë ¸ëŠ”ì§€) í™•ì¸í•´ì¤˜.", [
            { text:"í™•ì¸", kind:"primary", onClick: hideMsg }
          ]);
        }
      }
    },
    { text:"ë‹«ê¸°", kind:"", onClick: hideMsg }
  ]);
}

/***************
 * ë¦¬ì…‹
 ***************/
function resetToTheater(){
  stopCountdown();
  stopWait();
  stopGrapeDisappear();
  closeStartOverlay();

  app.selectedTheater = null;
  app.pickedDate = null;
  app.captchaAnswer = "";

  app.readyAt = null;
  app.bookClickedAt = null;
  app.captchaShownAt = null;
  app.captchaPassedAt = null;
  app.seatsShownAt = null;
  app.seatsSuccessAt = null;

  app.seatFailShown = false;

  app.seatLocked = true;

  app.seatEdit = false;
  app.seatPoints = [];
  app.seatKey = null;
  app.snapGuide = [];
  app.snapKey = null;
  app.grapes = [];

  resetView();

  $all(".theaterCard").forEach(x=>x.classList.remove("sel"));

  setPhase(Phase.THEATER);
  setMainButton("ì‹œì‘í•˜ê¸°", false);
}

/***************
 * â† ì´ì „ìœ¼ë¡œ
 ***************/
function onBack(){
  switch(app.phase){
    case Phase.SEATS:
      stopGrapeDisappear();
      if(app.settings.captcha==="off") setPhase(Phase.CAL);
      else setPhase(Phase.CAPTCHA);
      break;
    case Phase.CAPTCHA:
      setPhase(Phase.CAL);
      break;
    case Phase.CAL:
      setPhase(Phase.DETAIL);
      setMainButton("íŒë§¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", false);
      openStartOverlay();
      break;
    case Phase.WAIT:
      stopWait();
      setPhase(Phase.DETAIL);
      setMainButton("íŒë§¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", false);
      openStartOverlay();
      break;
    case Phase.READY:
    case Phase.COUNTDOWN:
    case Phase.DETAIL:
      resetToTheater();
      break;
    case Phase.THEATER:
    default:
      break;
  }
}

/***************
 * ë¶€íŠ¸
 ***************/
function boot(){
  initCounters();
  saveSettings(app.settings);

  setPhase(Phase.THEATER);
  setMainButton("ì‹œì‘í•˜ê¸°", false);

  $("#zoomIn").addEventListener("click", ()=> zoomUISet(+0.15));
  $("#zoomOut").addEventListener("click", ()=> zoomUISet(-0.15));

  $all(".theaterCard").forEach(card=>{
    card.addEventListener("click", ()=>{
      $all(".theaterCard").forEach(x=>x.classList.remove("sel"));
      card.classList.add("sel");

      app.selectedTheater = card.dataset.theater;
      setMainButton("ì‹œì‘í•˜ê¸°", true);
    });
  });

  $("#mainBtn").addEventListener("click", ()=>{
    if(app.phase === Phase.THEATER){
      if(!app.selectedTheater) return;
      applyTheaterToDetail();
      setPhase(Phase.DETAIL);
      setMainButton("íŒë§¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", false);
      openStartOverlay();
      return;
    }
    if(app.phase === Phase.READY){
      onClickBook();
      return;
    }
  });

  $("#startCancel").addEventListener("click", closeStartOverlay);
  $("#startGo").addEventListener("click", ()=>{
    closeStartOverlay();
    incStarts();
    startCountdown();
  });

  $all(".diffBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      app.settings.difficulty = btn.dataset.diff;
      saveSettings(app.settings);
      renderDiffUI();
    });
  });
  renderDiffUI();

  $("#capOk").addEventListener("click", onCaptchaOk);
  $("#capInput").addEventListener("keydown", (e)=>{
    if(e.key === "Enter") onCaptchaOk();
  });

  $("#navBack").addEventListener("click", onBack);

  // ğŸ”’ ì¢Œì„ í¸ì§‘ í† ê¸€ (+ ë¹„ë°€ë²ˆí˜¸)
  $("#editSeatsBtn").addEventListener("click", async ()=>{
    if(app.phase !== Phase.SEATS) return;

    if(app.seatEdit){
      setSeatEditMode(false);
      return;
    }

    if(app.seatLocked){
      const pw = prompt("ì¢Œì„ í¸ì§‘ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
      if(pw !== ADMIN_PW){
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
        return;
      }
      app.seatLocked = false;
      updateSeatLockUI();
      alert("í¸ì§‘ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // í¸ì§‘ ëª¨ë“œì—ì„œë„ ê¸°ë³¸ ì¢Œì„ ìë™ ë¡œë“œ ì‹œë„
    await ensureSeatPointsLoaded();

    setSeatEditMode(true);
  });

  $("#exportSeatsBtn").addEventListener("click", openExportModal);
  $("#importSeatsBtn").addEventListener("click", openImportModal);

  $("#saveSeatsBtn").addEventListener("click", ()=>{
    if(!app.seatEdit) return;

    saveSeatPoints();
    app.seatLocked = true;

    showMsg("ì €ì¥ ì™„ë£Œ", `ì¢Œì„ ${app.seatPoints.length}ê°œ ì €ì¥í–ˆì–´!\n(ê·¹ì¥ë³„ë¡œ ë”°ë¡œ ì €ì¥ë¼)\nì €ì¥ í›„ í¸ì§‘ ì ê¸ˆ(ğŸ”’)ë„ ë‹¤ì‹œ ê±¸ì—ˆì–´!`, [
      { text:"í™•ì¸", kind:"primary", onClick: hideMsg }
    ]);

    setSeatEditMode(false);
  });

  $("#resetSeatsBtn").addEventListener("click", ()=>{
    if(!app.seatEdit) return;
    app.seatPoints = [];
    renderSeatDotsForEdit();
  });

  $("#snapBuildBtn").addEventListener("click", async ()=>{
    if(!app.seatEdit) return;
    await buildSnapGuideFromImage();
  });

  $("#zoomResetBtn").addEventListener("click", ()=> resetView());

  $("#seatBoard").addEventListener("click", seatBoardClickToEdit);

  $("#seatBoard").addEventListener("wheel", (e)=>{
    e.preventDefault();
    const delta = e.deltaY;
    const factor = delta > 0 ? 0.92 : 1.08;
    zoomAt(e.clientX, e.clientY, app.view.scale * factor);
  }, { passive:false });

  const board = $("#seatBoard");
  board.addEventListener("pointerdown", (e)=>{
    const isDot = !!(e.target && e.target.closest && e.target.closest(".seatDot"));
    if(isDot && !app.seatEdit){
      return;
    }

    board.setPointerCapture(e.pointerId);

    board._pointers = board._pointers || new Map();
    board._pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});

    if(board._pointers.size === 1){
      app.view.dragging = true;
      app.view.dragStart = {x:e.clientX, y:e.clientY, tx:app.view.tx, ty:app.view.ty};
    }else if(board._pointers.size === 2){
      const pts = Array.from(board._pointers.values());
      const dx = pts[0].x - pts[1].x;
      const dy = pts[0].y - pts[1].y;
      const dist2 = Math.sqrt(dx*dx + dy*dy);
      const midX = (pts[0].x + pts[1].x)/2;
      const midY = (pts[0].y + pts[1].y)/2;
      app.view.pinch = {dist:dist2, midX, midY, scale:app.view.scale, tx:app.view.tx, ty:app.view.ty};
      app.view.dragging = false;
    }
  });

  board.addEventListener("pointermove", (e)=>{
    if(board._pointers && board._pointers.has(e.pointerId)){
      board._pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});
    }

    if(board._pointers && board._pointers.size === 2 && app.view.pinch){
      const pts = Array.from(board._pointers.values());
      const dx = pts[0].x - pts[1].x;
      const dy = pts[0].y - pts[1].y;
      const dist2 = Math.sqrt(dx*dx + dy*dy);
      const midX = (pts[0].x + pts[1].x)/2;
      const midY = (pts[0].y + pts[1].y)/2;

      const ratio = dist2 / (app.view.pinch.dist || dist2);
      const nextScale = app.view.pinch.scale * ratio;

      zoomAt(midX, midY, nextScale);
      return;
    }

    if(app.view.dragging){
      const dx = e.clientX - app.view.dragStart.x;
      const dy = e.clientY - app.view.dragStart.y;
      app.view.tx = app.view.dragStart.tx + dx;
      app.view.ty = app.view.dragStart.ty + dy;
      clampView();
      applyViewTransform();
      updateZoomUI();
    }
  });

  function endPointer(e){
    if(board._pointers){
      board._pointers.delete(e.pointerId);
    }
    if(board._pointers && board._pointers.size < 2){
      app.view.pinch = null;
    }
    if(board._pointers && board._pointers.size === 0){
      app.view.dragging = false;
    }
  }
  board.addEventListener("pointerup", endPointer);
  board.addEventListener("pointercancel", endPointer);
  board.addEventListener("pointerleave", endPointer);

  $("#startOverlay").addEventListener("click", (e)=>{
    if(e.target === $("#startOverlay")) closeStartOverlay();
  });
}

boot();
</script>
</body>
</html>